<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统通知闹钟</title>
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1c1c1e;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --accent-color: #ff9f0a;
      --danger-color: #ff453a;
      --separator: #38383a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* 顶部时钟区域 */
    .header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid var(--separator);
    }

    .current-time {
      font-size: 48px;
      font-weight: 300;
    }

    .current-date {
      color: var(--text-secondary);
      font-size: 16px;
      margin-top: 5px;
    }

    /* 闹钟列表 */
    .alarm-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .alarm-item {
      background-color: var(--bg-color);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--separator);
      transition: background-color 0.2s;
    }

    .alarm-item:active {
      background-color: var(--card-bg);
    }

    .alarm-info {
      display: flex;
      flex-direction: column;
    }

    .alarm-time {
      font-size: 42px;
      font-weight: 300;
      line-height: 1;
    }

    .alarm-time.disabled {
      color: var(--text-secondary);
    }

    .alarm-meta {
      margin-top: 5px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* 开关样式 */
    .switch {
      position: relative;
      display: inline-block;
      width: 51px;
      height: 31px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #39393d;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background-color: #34c759;
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    /* 底部操作栏 */
    .footer {
      padding: 20px;
      display: flex;
      justify-content: center;
      background-color: rgba(28, 28, 30, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--separator);
    }

    .add-btn {
      background-color: transparent;
      border: none;
      color: var(--accent-color);
      font-size: 40px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    /* 模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      z-index: 1000;
      flex-direction: column;
    }

    .modal.active {
      display: flex;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    .btn-cancel {
      color: var(--accent-color);
    }

    .btn-save {
      color: var(--accent-color);
      font-weight: bold;
    }

    .btn-delete {
      color: var(--danger-color);
      width: 100%;
      padding: 15px;
      background: var(--card-bg);
      border: none;
      font-size: 16px;
      margin-top: 20px;
      border-radius: 10px;
    }

    .modal-content {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }

    .time-picker-container {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    input[type="time"] {
      background: var(--card-bg);
      border: none;
      color: var(--text-primary);
      font-size: 48px;
      padding: 10px 20px;
      border-radius: 10px;
      font-family: inherit;
      color-scheme: dark;
    }

    .setting-group {
      background-color: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .setting-item {
      padding: 15px;
      border-bottom: 1px solid var(--separator);
      display: flex;
      flex-direction: column;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      font-size: 16px;
      margin-bottom: 10px;
    }

    .week-selector {
      display: flex;
      justify-content: space-between;
    }

    .week-day {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background-color: #2c2c2e;
      border: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .week-day.selected {
      background-color: var(--accent-color);
      color: #000;
      font-weight: bold;
    }

    input[type="text"] {
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 16px;
      width: 100%;
      outline: none;
    }

    .permission-banner {
      background-color: var(--accent-color);
      color: #000;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      display: none;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div id="permissionBanner" class="permission-banner" onclick="requestPermission()">
    点击此处开启通知权限，否则闹钟无法生效
  </div>

  <div class="header">
    <div class="current-time" id="clock">00:00</div>
    <div class="current-date" id="date">1月1日 星期一</div>
  </div>

  <ul class="alarm-list" id="alarmList">
    <!-- 闹钟列表将通过JS生成 -->
  </ul>

  <div class="footer">
    <button class="add-btn" onclick="openModal()">+</button>
    <button
      style="position: absolute; right: 20px; background: none; border: 1px solid #333; color: #666; padding: 5px 10px; border-radius: 5px; cursor: pointer;"
      onclick="testNotification()">测试通知</button>
  </div>

  <!-- 添加/编辑闹钟模态框 -->
  <div class="modal" id="alarmModal">
    <div class="modal-header">
      <button class="modal-btn btn-cancel" onclick="closeModal()">取消</button>
      <span style="font-weight: bold;" id="modalTitle">添加闹钟</span>
      <button class="modal-btn btn-save" onclick="saveAlarm()">存储</button>
    </div>
    <div class="modal-content">
      <div class="time-picker-container">
        <input type="time" id="timeInput" required>
      </div>

      <div class="setting-group">
        <div class="setting-item">
          <span class="setting-label">重复</span>
          <div class="week-selector" id="weekSelector">
            <button class="week-day" data-day="1" onclick="toggleDay(this)">一</button>
            <button class="week-day" data-day="2" onclick="toggleDay(this)">二</button>
            <button class="week-day" data-day="3" onclick="toggleDay(this)">三</button>
            <button class="week-day" data-day="4" onclick="toggleDay(this)">四</button>
            <button class="week-day" data-day="5" onclick="toggleDay(this)">五</button>
            <button class="week-day" data-day="6" onclick="toggleDay(this)">六</button>
            <button class="week-day" data-day="0" onclick="toggleDay(this)">日</button>
          </div>
        </div>
        <div class="setting-item">
          <span class="setting-label">标签</span>
          <input type="text" id="labelInput" placeholder="闹钟">
        </div>
      </div>

      <button id="deleteBtn" class="btn-delete" style="display: none;" onclick="deleteCurrentAlarm()">删除闹钟</button>
    </div>
  </div>

  <script>
    // 状态管理
    let alarms = JSON.parse(localStorage.getItem('alarms')) || [];
    let editingId = null;
    let checkInterval = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      updateClock();
      setInterval(updateClock, 1000);
      renderAlarms();
      checkPermission();
      startAlarmChecker();
    });

    // 时钟更新
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
      document.getElementById('date').textContent = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
    }

    // 权限处理
    function checkPermission() {
      if (Notification.permission !== 'granted') {
        document.getElementById('permissionBanner').style.display = 'block';
      } else {
        document.getElementById('permissionBanner').style.display = 'none';
      }
    }

    function requestPermission() {
      Notification.requestPermission().then(permission => {
        checkPermission();
        if (permission === 'granted') {
          new Notification('通知已开启', { body: '闹钟将通过系统通知提醒您' });
        }
      });
    }

    // 渲染列表
    function renderAlarms() {
      const list = document.getElementById('alarmList');
      list.innerHTML = '';

      alarms.sort((a, b) => a.time.localeCompare(b.time));

      alarms.forEach(alarm => {
        const li = document.createElement('li');
        li.className = 'alarm-item';
        li.onclick = (e) => {
          if (!e.target.closest('.switch')) {
            editAlarm(alarm.id);
          }
        };

        const repeatText = getRepeatText(alarm.days);
        const labelText = alarm.label || '闹钟';

        li.innerHTML = `
                    <div class="alarm-info">
                        <span class="alarm-time ${!alarm.enabled ? 'disabled' : ''}">${alarm.time}</span>
                        <span class="alarm-meta">${labelText}, ${repeatText}</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" ${alarm.enabled ? 'checked' : ''} onchange="toggleAlarm('${alarm.id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;
        list.appendChild(li);
      });
    }

    function getRepeatText(days) {
      if (days.length === 0) return '不重复';
      if (days.length === 7) return '每天';
      if (days.length === 5 && !days.includes(0) && !days.includes(6)) return '工作日';
      if (days.length === 2 && days.includes(0) && days.includes(6)) return '周末';

      const weekMap = { 0: '周日', 1: '周一', 2: '周二', 3: '周三', 4: '周四', 5: '周五', 6: '周六' };
      return days.sort().map(d => weekMap[d]).join(' ');
    }

    // 模态框操作
    function openModal(alarm = null) {
      // 尝试请求权限（利用用户的点击操作）
      if (Notification.permission !== 'granted') {
        Notification.requestPermission();
      }

      const modal = document.getElementById('alarmModal');
      const deleteBtn = document.getElementById('deleteBtn');
      const title = document.getElementById('modalTitle');

      // 重置表单
      document.querySelectorAll('.week-day').forEach(btn => btn.classList.remove('selected'));

      if (alarm) {
        editingId = alarm.id;
        title.textContent = '编辑闹钟';
        document.getElementById('timeInput').value = alarm.time;
        document.getElementById('labelInput').value = alarm.label;
        alarm.days.forEach(day => {
          document.querySelector(`.week-day[data-day="${day}"]`).classList.add('selected');
        });
        deleteBtn.style.display = 'block';
      } else {
        editingId = null;
        title.textContent = '添加闹钟';
        // 默认当前时间
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        document.getElementById('timeInput').value = timeStr;
        document.getElementById('labelInput').value = '';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('alarmModal').classList.remove('active');
    }

    function toggleDay(btn) {
      btn.classList.toggle('selected');
    }

    // 数据操作
    function saveAlarm() {
      const time = document.getElementById('timeInput').value;
      if (!time) return;

      const label = document.getElementById('labelInput').value;
      const days = Array.from(document.querySelectorAll('.week-day.selected'))
        .map(btn => parseInt(btn.dataset.day));

      if (editingId) {
        const index = alarms.findIndex(a => a.id === editingId);
        if (index !== -1) {
          alarms[index] = { ...alarms[index], time, label, days, enabled: true };
        }
      } else {
        const newAlarm = {
          id: Date.now().toString(),
          time,
          label,
          days,
          enabled: true,
          lastTriggered: null // 防止同一分钟重复触发
        };
        alarms.push(newAlarm);
      }

      saveToStorage();
      closeModal();
      renderAlarms();
    }

    function deleteCurrentAlarm() {
      if (editingId) {
        alarms = alarms.filter(a => a.id !== editingId);
        saveToStorage();
        closeModal();
        renderAlarms();
      }
    }

    function toggleAlarm(id, enabled) {
      const alarm = alarms.find(a => a.id === id);
      if (alarm) {
        alarm.enabled = enabled;
        // 如果重新开启，重置触发状态
        if (enabled) alarm.lastTriggered = null;
        saveToStorage();
        renderAlarms(); // 重新渲染以更新样式
      }
    }

    function editAlarm(id) {
      const alarm = alarms.find(a => a.id === id);
      if (alarm) openModal(alarm);
    }

    function saveToStorage() {
      localStorage.setItem('alarms', JSON.stringify(alarms));
    }

    // 闹钟检查器
    function startAlarmChecker() {
      // 每秒检查一次
      checkInterval = setInterval(() => {
        const now = new Date();
        const currentDay = now.getDay(); // 0-6
        const currentTime = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        // 格式化为 YYYY-MM-DD HH:mm 用于精确去重
        const currentFullTime = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()} ${currentTime}`;

        alarms.forEach(alarm => {
          if (!alarm.enabled) return;

          // 检查时间是否匹配
          if (alarm.time === currentTime) {
            // 检查是否已经在这一分钟触发过
            if (alarm.lastTriggered === currentFullTime) return;

            // 检查重复规则
            let shouldTrigger = false;
            if (alarm.days.length === 0) {
              // 不重复：只触发一次
              shouldTrigger = true;
            } else {
              // 重复：检查今天是否在规则内
              if (alarm.days.includes(currentDay)) {
                shouldTrigger = true;
              }
            }

            if (shouldTrigger) {
              triggerAlarm(alarm, currentFullTime);
            }
          }
        });
      }, 1000);
    }

    function triggerAlarm(alarm, triggerTime) {
      // 标记为已触发
      alarm.lastTriggered = triggerTime;

      // 发送通知
      sendNotification(alarm.label || '闹钟响了', `时间到了：${alarm.time}`);

      // 如果是不重复的闹钟，触发后关闭
      if (alarm.days.length === 0) {
        alarm.enabled = false;
        renderAlarms();
      }

      saveToStorage();
    }

    function sendNotification(title, body) {
      if (!("Notification" in window)) {
        alert("当前浏览器不支持桌面通知");
        return;
      }

      if (Notification.permission === "granted") {
        new Notification(title, {
          body: body,
          icon: 'https://cdn-icons-png.flaticon.com/512/899/899054.png',
          requireInteraction: true
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            new Notification(title, {
              body: body,
              icon: 'https://cdn-icons-png.flaticon.com/512/899/899054.png',
              requireInteraction: true
            });
          } else {
            // 权限被拒绝或忽略
            showPermissionBanner(body);
          }
        });
      } else {
        // 权限已被明确拒绝
        showPermissionBanner(body);
      }
    }

    function showPermissionBanner(msg) {
      const banner = document.getElementById('permissionBanner');
      banner.style.display = 'block';
      banner.style.backgroundColor = '#ff453a';
      banner.textContent = `闹钟已触发 (${msg})，但系统通知权限未开启！点击此处开启。`;
    }

    function testNotification() {
      if (!("Notification" in window)) {
        alert("当前浏览器不支持桌面通知");
      } else if (Notification.permission === "granted") {
        new Notification('测试成功', {
          body: '测试 Windows 系统原生通知效果',
          icon: 'https://cdn-icons-png.flaticon.com/512/899/899054.png'
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            new Notification('测试成功', {
              body: '测试 Windows 系统原生通知效果',
              icon: 'https://cdn-icons-png.flaticon.com/512/899/899054.png'
            });
          }
        });
      } else {
        alert('通知权限已被拒绝。请在浏览器地址栏左侧点击锁形图标或设置图标，重置通知权限。');
      }
    }
  </script>
</body>

</html>